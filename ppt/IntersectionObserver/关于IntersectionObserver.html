<!doctype html><html><head><meta charset=UTF-8><title>使用 intersectionObserver 提高性能 - By 舒丽琦</title><link rel=stylesheet href=http://cdn.staticfile.org/font-awesome/4.7.0/css/font-awesome.min.css>
<link rel=stylesheet href=http://cdn.staticfile.org/prism/1.15.0/themes/prism.min.css>
<link rel=stylesheet href=http://cdn.staticfile.org/KaTeX/0.10.0-rc.1/katex.min.css><link href=./css/chunk-vendors.4e4765ff.css rel=stylesheet></head><body><div><article id=webslides><section slide class="slide bg-back aligncenter"><div class=wrap wrap=true><h1 class="tobuild zoomIn">IntersectionObserver</h1><p class="text-intro tobuild zoomIn">By 舒丽琦</p></div></section><section slide class="slide bg-light aligncenter"><div class=wrap wrap=true><h1 class=fadeInRight>问题的提出？</h1><hr><div class=grid><div class=column><p><a href=javascript:void(0) class="button radius tobuild fadeInRight">1.懒加载（当页面滚动时，懒加载图片和其他内容）</a></p></div><div class=column><p><a href=javascript:void(0) class="button radius tobuild fadeInRight">2.实现“无限滚动“功能的页面</a></p></div></div></div></section><section slide class="slide bg-light aligncenter"><div class=wrap wrap=true><h1>懒加载图片</h1><hr><div class="vertical-align grid"><div class=column><img src=/Users/shuliqi/ppt/intersectionObserver/public/images/lazyLoad.jpg></div><div class=column><pre class=language-javascript><code class=language-javascript>

<span class="token keyword">var</span> imgs <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelectorAll</span><span class="token punctuation">(</span><span class="token string">'img'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

window<span class="token punctuation">.</span><span class="token function-variable function">onscroll</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>

  <span class="token comment">// 浏览器滚动过的高度</span>
  <span class="token keyword">var</span> scrollTop <span class="token operator">=</span> document<span class="token punctuation">.</span>body<span class="token punctuation">.</span>scrollTop <span class="token operator">||</span> document<span class="token punctuation">.</span>documentElement<span class="token punctuation">.</span>scrollTop<span class="token punctuation">;</span>


  <span class="token comment">// 可视区域的高度</span>
  <span class="token keyword">var</span> winTop <span class="token operator">=</span> window<span class="token punctuation">.</span>innerHeight<span class="token punctuation">;</span>


  <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">var</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i <span class="token operator">&lt;</span> imgs<span class="token punctuation">.</span>length<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>

    <span class="token comment">// 当图片距离页面顶部的距离 &lt; 浏览器滚动过的高度 +  可视区域的高度</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>imgs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>offsetTop <span class="token operator">&lt;</span> scrollTop <span class="token operator">+</span> winTop <span class="token punctuation">)</span><span class="token punctuation">{</span>


      imgs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>src <span class="token operator">=</span> imgs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span><span class="token string">'data-src'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>

</code></pre></div></div></div></section><section slide class="slide bg-light aligncenter"><div class=wrap wrap=true><h1>无限加载</h1><hr><div class=grid><div class=column><img src=/Users/shuliqi/ppt/intersectionObserver/public/images/wuxian.jpg></div><div class=column><pre class=language-javascript><code class=language-javascript><span class="token keyword">var</span> page <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">//当前页的页码</span>
<span class="token keyword">var</span> flagNoData <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span> <span class="token comment">//false</span>
window<span class="token punctuation">.</span><span class="token function-variable function">onscroll</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">//真实内容的高度</span>
  <span class="token keyword">var</span> pageHeight <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span>
    document<span class="token punctuation">.</span>body<span class="token punctuation">.</span>scrollHeight<span class="token punctuation">,</span>
    document<span class="token punctuation">.</span>body<span class="token punctuation">.</span>offsetHeight
  <span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">//视窗的高度</span>
  <span class="token keyword">var</span> viewportHeight <span class="token operator">=</span>
    window<span class="token punctuation">.</span>innerHeight <span class="token operator">||</span>
    document<span class="token punctuation">.</span>documentElement<span class="token punctuation">.</span>clientHeight <span class="token operator">||</span>
    document<span class="token punctuation">.</span>body<span class="token punctuation">.</span>clientHeight <span class="token operator">||</span>
    <span class="token number">0</span><span class="token punctuation">;</span>

  <span class="token comment">//隐藏的高度</span>
  <span class="token keyword">var</span> scrollHeight <span class="token operator">=</span>
    window<span class="token punctuation">.</span>pageYOffset <span class="token operator">||</span>
    document<span class="token punctuation">.</span>documentElement<span class="token punctuation">.</span>scrollTop <span class="token operator">||</span>
    document<span class="token punctuation">.</span>body<span class="token punctuation">.</span>scrollTop <span class="token operator">||</span>
    <span class="token number">0</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>falgNoData<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//数据全部加载完了</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>pageHeight <span class="token operator">-</span> viewportHeight <span class="token operator">-</span> scrollHeight <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//如果满足触发条件，执行</span>
    <span class="token function">showAjax</span><span class="token punctuation">(</span>page<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 去加载数据</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div></div></div></section><section slide class="slide bg-light aligncenter"><div class=wrap wrap=true><h5>传统的实现方法是，监听到<code>scroll</code>事件后，获取相关元素的坐标来进行判断。这种方法是有缺点的。由于<code>scroll</code>事件密集发生，计算量很大，容易造成性能</h5><hr><h3 class="tobuild fadeInRight">那么在这样的背景下， 我们有没有更好的解决的办法呢？</h3></div></section><section slide class="slide bg-light aligncenter"><div class=wrap wrap=true><h2>关于 IntersectionObserver</h2><hr><div class="tobuild fadeInRight bg-white shadow"><ul class="flexblock "><li><h4>IntersectionObserver 接口 (Intersection Observer API)： 为开发者提供了一种可以异步监听目标元素与其祖先或者视窗(viewport)交叉状态的手段。祖先元素与视窗(viewport)被称为根(root)。</h4></li></ul></div></div></section><section slide class="slide bg-light aligncenter"><div class=wrap wrap=true><p><img src=/Users/shuliqi/ppt/intersectionObserver/public/images/2.jpg alt=swipe></p><h4 class="tobuild fadeInRight">intersectionObserver 能检测到什么？</h4><h3 class="tobuild fadeInRight">目标元素与 root 元素刚开始交叉<strong>和</strong>目标元素与 root 元素刚开始不交叉都能检测到</h3><p><a href=https://codepen.io/shuliqi/pen/wvKBBWb class="button tobuild fadeInRight" target=_blank>举个小 🌰</a></p></div></section><section slide class="slide bg-light aligncenter"><div class=wrap wrap=true><h2>IntersectionObserver 如何解决？</h2><hr><div class="tobuild fadeInRight bg-white shadow"><ul class="flexblock "><li><h4>IntersectionObserver API 是异步的， 不随着目标元素的滚动同步触发。即只有在线程空闲下来才会执行观察器。这意味着这个观察器的优先级非常的低，只有在其他的任务执行完，浏览器空闲了才会执行。</h4></li></ul></div></div></section><section slide class="slide bg-light aligncenter"><div class=wrap wrap=true><h2>IntersectionObserver API</h2><hr><ul class="tobuild fadeInRight flexblock"><li><h5>API 的调用</h5><pre class=language-javascript><code class=language-javascript><span class="token keyword">var</span> io <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">IntersectionObserver</span><span class="token punctuation">(</span>callback<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></li><li><h5>参数</h5><pre class=language-textile><code class=language-textile><span class="token phrase">1. callback 是当被监听元素的交叉状态变化时，触发的回调函数
2. options是一个配置参数对象，可选的， 有默认的属性值
</span></code></pre></li></ul><ul class="tobuild fadeInRight flexblock"><li><h5>构造函数的返回值是一个观察实例， 实例的方法：</h5><pre class=language-javascript><code class=language-javascript><span class="token comment">//  对元素target添加监听，当target元素变化时，就会触发回调</span>
io<span class="token punctuation">.</span><span class="token function">observe</span><span class="token punctuation">(</span>document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">"shuliqi"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 移除一个监听，移除之后，target元素的交叉状态变化，将不再触发回调函数</span>
io<span class="token punctuation">.</span><span class="token function">unobserve</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 停止所有的监听</span>
io<span class="token punctuation">.</span><span class="token function">disconnect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></li><li><h5><code>observe()</code>的参数是一个 DOM 节点对象，如果要观察多个节点，就要多次调用这个方法。</h5><pre class=language-javascript><code class=language-javascript>io<span class="token punctuation">.</span><span class="token function">observe</span><span class="token punctuation">(</span>eleA<span class="token punctuation">)</span><span class="token punctuation">;</span>

io<span class="token punctuation">.</span><span class="token function">observe</span><span class="token punctuation">(</span>eleB<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></li></ul><p><a href=https://codepen.io/shuliqi/pen/wvKBBWb class="button tobuild fadeInRight" target=_blank>还是刚才的小小 🌰</a></p><ul class="tobuild fadeInRight flexblock"><li><pre class=language-javascript><code class=language-javascript><span class="token keyword">const</span> options <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span> <span class="token comment">// 配置</span>
document<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span>
  <span class="token string">"DOMContentLoaded"</span><span class="token punctuation">,</span>
  <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//  目标元素</span>
    <span class="token keyword">const</span> target <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">"nb"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//  API 调用</span>
    <span class="token keyword">var</span> io <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">IntersectionObserver</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">entries</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>entries<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>isIntersecting<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">"tips"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerText <span class="token operator">=</span> <span class="token string">"我出现了"</span><span class="token punctuation">;</span>

        <span class="token comment">// 移除一个监听，移除之后，target元素的交叉状态变化，将不再触发回调函数</span>
        <span class="token comment">// io.unobserve(target)</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">"tips"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerText <span class="token operator">=</span> <span class="token string">"我消失了"</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//  对元素target添加监听，当target元素变化时，就会触发回调</span>
    io<span class="token punctuation">.</span><span class="token function">observe</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  options
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></li></ul></div></section><section slide class="slide bg-light aligncenter"><div class=wrap wrap=true><h2>callback</h2><hr><p class="tobuild fadeInRight">目标元素的交叉状态发生改变时，就会调用观察器的回调函数<code>callback</code>。</p><p class="tobuild fadeInRight"><code>callback</code>一般会调用两次。一次是目标元素刚刚进入 root 元素（开始交叉）, 另一次是完全离开 root（开始不相交）。</p><h4 class="tobuild fadeInRight">callback 有什么参数吗？</h4></div></section><section slide class="slide bg-light aligncenter"><div class=wrap wrap=true><h1>举个 🌰</h1><hr><div class="tobuild fadeInRight grid"><div class=column><p>以下的代码， 在 chrome 控制台进行调试，这里的$0 代表我审查元素选中的节点。</p><pre class=language-javascript><code class=language-javascript><span class="token keyword">var</span> io <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">IntersectionObserver</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">entries</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>entries<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
io<span class="token punctuation">.</span><span class="token function">observe</span><span class="token punctuation">(</span>$<span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><div class=column><p><img src=/Users/shuliqi/ppt/intersectionObserver/public/images/3.jpg alt=swipe></p></div></div><h4 class="tobuild fadeInRight">由此我们可知 callback 函数有个参数，它是<code>IntersectionObserverEntry</code>对象数组，举例来说，如果同时有两个被观察的对象的可见性发生变化， 那么 entries 数组就会有两个成员。</h4><h2></h2></div></section><section slide class="slide bg-light aligncenter"><div class=wrap wrap=true><h2>IntersectionObserverEntry 对象</h2><hr><p class="tobuild fadeInRight">IntersectionObserverEntry 对象提供观察元素的信息</p><h3></h3></div></section><section slide class="slide bg-light aligncenter"><div class=wrap wrap=true><div class=grid><div class=column><p><img src=/Users/shuliqi/ppt/intersectionObserver/public/images/4.jpg alt=swipe></p></div><div class=column><pre class=language-javascript><code class=language-javascript><span class="token punctuation">{</span>
  time<span class="token operator">:</span> <span class="token number">78463997.025</span><span class="token punctuation">,</span>
  rootBounds<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  boundingClientRect<span class="token operator">:</span> DOMRectReadOnly <span class="token punctuation">{</span>
   <span class="token comment">// ...</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  intersectionRect<span class="token operator">:</span> DOMRectReadOnly<span class="token punctuation">{</span>
   <span class="token comment">// ...</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  isIntersecting<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  intersectionRatio<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
  target<span class="token operator">:</span> html<span class="token punctuation">,</span>
  isVisible<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre></div></div></div></section><section slide class="slide bg-light alignleft"><div class=wrap wrap=true><div class=grid><div class=column><p><img src=/Users/shuliqi/ppt/intersectionObserver/public/images/5.jpg alt=""></p></div><div class=column><table><thead><tr><th>属性</th><th>解释</th></tr></thead><tbody><tr><td><strong>time</strong></td><td>返回一个记录从<code>IntersectionObserver</code>开始实例化的时间到交叉状态发生改变的时间的时间戳。对比时间：实例化的时间。例子：值为 1000 时，表示在 IntersectionObserver 实例化的 1 秒钟之后，目标元素的交叉状态发生改变了</td></tr><tr><td><strong>rootBounds</strong></td><td>根元素的矩形区域的信息，<code>getBoundingClientRect()</code>方法的返回值，如果没有根元素（即直接相对于视口滚动），则返回 null</td></tr><tr><td><strong>boundingClientRect</strong></td><td>目标元素的矩形信息</td></tr><tr><td><strong>isIntersecting</strong></td><td>目标元素当前是否可见 Boolean 值 可见为 true</td></tr><tr><td><strong>intersectionRect</strong></td><td>目标元素与视口（或 root 根元素）的交叉区域的信息</td></tr><tr><td><strong>intersectionRatio</strong></td><td>目标元素的可见比例，即<code>intersectionRect</code>占<code>boundingClientRect</code>的比例，完全交叉时为<code>1</code>，完全不交叉时小于等于 0</td></tr></tbody></table></div></div><p class="tobuild fadeInRight"><strong>注意：</strong> 在 Chrome 78 版本中会返回<code>isVisible</code>属性，但是不知道是不是 Bug，无论元素是否可见，都为<code>false</code>，但是<code>isIntersecting</code>的表现是正常的，所以判断是否可见，可以根据<code>isTntersecting</code>来进行判断。</p></div></section><section slide class="slide bg-light aligncenter"><div class=wrap wrap=true><h1>options</h1><hr><p class="tobuild fadeIn"><code>IntersectionObserver</code>构造函数的第二参数是一个配置对象， 可配三属性。</p></div></section><section slide class="slide bg-light aligncenter"><div class=wrap wrap=true><h1><strong>threshold 属性</strong></h1><div class="bg-white shadow"><ul class="flexblock "><li><h4><code>threshold</code>属性： 决定了什么时候触发回调函数，它是一个数组， 每一个成员也是一个门槛值，当目标元素和根元素相交的面积占目标元素面积的百分比到达或跨过某些指定的临界值时就会触发回调函数</h4><p><code>threshold</code>的默认值是<code>:[0]</code>，即只有在开始进入，或者是完全离开视图区域时，才会触发。</p><pre class=language-javascript><code class=language-javascript><span class="token keyword">var</span> io <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">IntersectionObserver</span><span class="token punctuation">(</span>callback<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  threshold<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
io<span class="token punctuation">.</span><span class="token function">observe</span><span class="token punctuation">(</span>$<span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><p>用户可以自定义这个属性， [0, 0.5, 1]就表示 0%， 50%，75%， 100%交叉状态发生改变时， 就会触发回调函数。</p></li></ul></div><hr><p><a href=https://codepen.io/shuliqi/pen/dyYoJJJ class="button tobuild fadeInRight" target=_blank>举个小 🌰</a></p></div></section><section slide class="slide bg-light aligncenter"><div class=wrap wrap=true><h1>root 属性</h1><hr><div class="bg-white shadow"><ul class="flexblock "><li><p><code>root</code>属性指定目标元素所在的容器节点（即根元素）。注意，容器元素必须是目标元素的祖先节点。</p><p>默认值是 null, 表示浏览器窗口。</p></li></ul></div></div></section><section slide class="slide bg-light aligncenter"><div class=wrap wrap=true><h1><strong>rootMargin</strong>属性</h1><hr><div class="bg-white shadow"><ul class="flexblock "><li><div class=grid><div class=column><p><code>rootMargin属性:</code>用来扩大或者缩小视窗的大小， 使用 css 的定义方式， <code>10px 10px 10px 20px</code> 表示 top，right,bottom, left 的值。默认值为 0px</p><pre class=language-javascript><code class=language-javascript><span class="token keyword">new</span> <span class="token class-name">IntersectionObserver</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span>rootMargin<span class="token punctuation">;</span>
<span class="token comment">// "0px 0px 0px 0px"</span>

<span class="token keyword">new</span> <span class="token class-name">IntersectionObserver</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> rootMargin<span class="token operator">:</span> <span class="token string">"50px"</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span>rootMargin<span class="token punctuation">;</span>
<span class="token comment">// "50px 50px 50px 50px"</span>

<span class="token keyword">new</span> <span class="token class-name">IntersectionObserver</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> rootMargin<span class="token operator">:</span> <span class="token string">"50% 0px"</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span>rootMargin<span class="token punctuation">;</span>
<span class="token comment">// "50% 0px 50% 0px"</span>

<span class="token keyword">new</span> <span class="token class-name">IntersectionObserver</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> rootMargin<span class="token operator">:</span> <span class="token string">"50% 0px 50px"</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span>rootMargin<span class="token punctuation">;</span>
<span class="token comment">// 50% 0px 50px 0px"</span>

<span class="token keyword">new</span> <span class="token class-name">IntersectionObserver</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> rootMargin<span class="token operator">:</span> <span class="token string">"1px 2px 3px 4px"</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span>rootMargin<span class="token punctuation">;</span>
<span class="token comment">// "1px 2px 3px 4px"</span>
</code></pre><p><a href=https://codepen.io/shuliqi/pen/QWjbaej class="button tobuild fadeInRight" target=_blank>举个小 🌰</a></p></div><div class=column><p><img src=/Users/shuliqi/ppt/intersectionObserver/public/images/6.jpg alt=""></p></div></div></li></ul></div><div></div></div></section><section slide class="slide bg-light aligncenter"><div class=wrap wrap=true><h1>有哪些应用呢？</h1></div></section><section slide class="slide bg-light aligncenter"><div class=wrap wrap=true><h1>懒加载图片</h1><hr><div class="bg-white shadow"><ul class="flexblock "><li><div class=grid><div class=column><h3><strong>懒加载（lazy load）</strong></h3><p>我们希望某些静态资源（比如图片），只有用户向下滚动，它们进入视口时才加载，这样可以节省带宽，提高网页性能。这就叫做”惰性加载”。</p><p>有了 IntersectionObserver API，实现起来就很容易了。</p><p><a href=https://codepen.io/shuliqi/pen/gOababR class="button tobuild fadeInRight" target=_blank>举个 🌰</a></p></div><div class=column><pre class=language-javascript><code class=language-javascript><span class="token keyword">const</span> io <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">IntersectionObserver</span><span class="token punctuation">(</span>callback<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 将图片的真实url设置为data-src src属性为占位图 元素可见时候替换src</span>
<span class="token keyword">let</span> imgs <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelectorAll</span><span class="token punctuation">(</span><span class="token string">"[data-src]"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">callback</span><span class="token punctuation">(</span><span class="token parameter">entries</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  entries<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token comment">// 遍历entries数组</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>item<span class="token punctuation">.</span>isIntersecting<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 当前元素可见</span>
      item<span class="token punctuation">.</span>target<span class="token punctuation">.</span>src <span class="token operator">=</span> item<span class="token punctuation">.</span>target<span class="token punctuation">.</span>dataset<span class="token punctuation">.</span>src<span class="token punctuation">;</span> <span class="token comment">// 替换src</span>

      <span class="token comment">// 停止观察当前元素 避免不可见时候再次调用callback函数</span>
      io<span class="token punctuation">.</span><span class="token function">unobserve</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span>target<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// io.observe接受一个DOM元素，添加多个监听 使用forEach</span>
imgs<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  io<span class="token punctuation">.</span><span class="token function">observe</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div></div></li></ul></div><div></div></div></section><section slide class="slide bg-light aligncenter"><div class=wrap wrap=true><h1>无限加载</h1><hr><div class="bg-white shadow"><ul class="flexblock "><li><div class=grid><div class=column><h3>*<strong>*无限加载**</strong></h3><pre class=language-javascript><code class=language-javascript>document<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">"DOMContentLoaded"</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> sum <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> <span class="token function-variable function">loadData</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> fragment <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createDocumentFragment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">var</span> div <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">"div"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      div<span class="token punctuation">.</span>className <span class="token operator">=</span> <span class="token string">"unit"</span><span class="token punctuation">;</span>
      div<span class="token punctuation">.</span>innerText <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">第 </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>sum<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> 个数据</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
      fragment<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>div<span class="token punctuation">)</span><span class="token punctuation">;</span>
      sum<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    document
      <span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">"app"</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">insertBefore</span><span class="token punctuation">(</span>fragment<span class="token punctuation">,</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">"loading"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> io <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">IntersectionObserver</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">entries</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>entries<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>isIntersecting<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 如果loading元素不可见，就加载数据</span>
      <span class="token function">loadData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  io<span class="token punctuation">.</span><span class="token function">observe</span><span class="token punctuation">(</span>document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">"loading"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><div class=column><p>无限滚动时，最好在页面底部有一个页尾栏（又称<a href=http://www.ruanyifeng.com/blog/2016/11/sentinels target=_blank>sentinels</a>）。一旦页尾栏可见，就表示用户到达了页面底部，从而加载新的条目放在页尾栏前面。这样做的好处是，不需要再一次调用<code>observe()</code>方法，现有的<code>IntersectionObserver</code>可以保持使用。</p><p><a href=https://codepen.io/shuliqi/pen/KKdwdNb class="button tobuild fadeIn" target=_blank>举个 🌰</a></p></div></div></li></ul></div><div></div></div></section><section slide class="slide bg-light aligncenter"><div class=wrap wrap=true><h1>是不是有点疑问？</h1><hr><div class="tobuild fadeInRight bg-white shadow"><ul class="flexblock "><li><div class=grid><div class="column tobuild fadeInRight"><p class="tobuild fadeInRight"><strong>一次性到达或跨过的多个临界值中选一个最近的</strong></p><p class="tobuild fadeInRight">问题：如果一个观察者实例设置了 11 个临界值：[0, 0.1, 0.2, 0.3, 0.4, 0.5, 0.6, 0.7, 0.8, 0.9, 1]，那么当目标元素和根元素从完全不相交状态滚动到相交率为 1 这一段时间里，回调函数会触发几次？</p><p class="tobuild fadeInRight">答案是： 不确定的。</p><p><a href=https://codepen.io/shuliqi/pen/zYvGaLL class="button tobuild fadeInRight" target=_blank>举个 🌰</a></p><p class="tobuild fadeInRight">如果滚动速度足够慢，每次相交率到达下一个临界值的时间点都发生在了不同的帧里（浏览器至少绘制了 11 次），那么就会有 11 次相交被检测到，回调函数就会被执行 11 次</p><p class="tobuild fadeInRight">如果滚动速度足够快，从不相交到完全相交是发生在同一个帧里的，浏览器只绘制了一次，浏览器虽然知道这一次滚动操作就满足了 11 个指定的临界值（从不相交到 0，从 0 到 0.1，从 0.1 到 0.2 ··· ），但它只会考虑最近的那个临界值，那就是 1，回调函数只触发一次.</p></div><div class="column tobuild fadeInRight"><p tobuild.fadeinright=""><strong>如何判断当前是否相交？</strong>.</p><p tobuild.fadeinright="">问题：前面的几个例子， 都使用了 isIntersecting 来判断目标元素是否在窗口里面，为什么？难道用 entry.intersectionRatio &gt; 0 判断不可以吗：</p><p><a href=https://codepen.io/shuliqi/pen/gOapKZP class="button tobuild fadeInRight" target=_blank>我是一个小小的 🌰</a></p><p class="tobuild fadeInRight">如果你滚动页面速度很慢，当目标元素的顶部和视口底部刚好挨上时，浏览器检测到相交了，回调函数触发了，但这时 entry.intersectionRatio 等于 0，会进入 else 分支，继续向下滚，回调函数再不会触发了，提示文字一直停留在不可见状态；但如果你滚动速度很快，当浏览器检测到相交时，已经越过了 0 那个临界值，存在了实际的相交面积，entry.intersectionRatio &gt; 0 也就为 true 了。所以这样写会导致代码执行不稳定，不可行</p></div><div class=column><p class="tobuild fadeInRight"><strong>贴边的情况是特例</strong></p><p class="tobuild fadeInRight">当目标元素从距离根元素很远到和根元素贴边，这时也会触发回调（假如 thresholds 里有 0），但这和工作原理相矛盾啊，离的很远相交率是 0，就算贴边，相交率还是 0，值并没有变，不应该触发回调啊。的确，这和基本工作原理矛盾，但这种情况是特例，目标元素从根元素外部很远的地方移动到和根元素贴边，也会当做是满足了临界值 0，即便 0 等于 0。</p><p class="tobuild fadeInRight">还有一个反过来的特例，就是目标元素从根元素内部的某个地方（相交率已经是 1）移动到和根元素贴边（还是 1），也会触发回调（假如 thresholds 里有 1）</p></div></div></li></ul></div><div></div></div></section><section slide class="slide bg-light aligncenter"><div class=wrap wrap=true><h1>最后，但是.....</h1></div></section><section slide class="slide bg-light aligncenter"><div class=wrap wrap=true><p>它浏览器兼容不太好，谨慎使用!!!!</p><p><img src=/Users/shuliqi/ppt/intersectionObserver/public/images/caniuse.png alt=swipe></p></div></section></article></div><script src=//cdn.staticfile.org/echarts/4.1.0-release/echarts.min.js></script><script>window.pluginsOptions = {}



document.addEventListener('DOMContentLoaded', () => {
    let isPrintMode = false;
    if(~location.search.indexOf('print-pdf')){
        isPrintMode = true;
        WebSlides.registerPlugin('scroll', function(){});
    }
    const ws = new WebSlides({
        loop: false
    })
    window.wsInstance = ws;
    if(isPrintMode){
        ws.slides.forEach(s=>s.show())
    }
}, false)</script><script src=./js/chunk-vendors.js></script><script src=./js/%E5%85%B3%E4%BA%8EIntersectionObserver.js></script></body></html>
